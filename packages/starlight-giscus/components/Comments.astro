---
const { editUrl, lang, slug } = Astro.props;
const {
    repo,
    repoId,
    category,
    categoryId,
    mapping,
    reactions,
    inputPosition,
    theme,
    lazy
} = globalThis.giscusConfig;
const preparedTheme = typeof theme === 'object' ? theme : { auto: theme };
---
{
    editUrl && slug && (
        <giscus-comments data-theme={JSON.stringify(preparedTheme)}>
            <div class="comments">
                <script src="https://giscus.app/client.js"
                    data-repo={repo}
                    data-repo-id={repoId}
                    data-category={category}
                    data-category-id={categoryId}
                    data-mapping={mapping}
                    data-strict="1"
                    data-reactions-enabled={+reactions}
                    data-emit-metadata="0"
                    data-input-position={inputPosition}
                    data-theme={preparedTheme.auto}
                    data-lang={lang}
                    data-loading={lazy ? 'lazy' : null}
                    crossorigin="anonymous"
                    async
                >
                </script>
            </div>
        </giscus-comments>

        <script>
            class GiscusComments extends HTMLElement {
                constructor() {
                    super();

                    const theme = JSON.parse(this.dataset.theme)

                    const darkTheme = theme.dark || 'dark';
                    const lightTheme = theme.light || 'light';
                    const preferredTheme = theme.auto || 'preferred_color_scheme';

                    const getThemeValue = (fallback = 'preferred_color_scheme') => {
                        const palette = localStorage.getItem('starlight-theme') || fallback

                        return palette === 'dark'
                            ? darkTheme
                            : (palette === 'light' ? lightTheme : preferredTheme)
                    }

                    const giscus = document.querySelector('script[src*="giscus.app"]')

                    giscus.dataset.theme = getThemeValue();

                    document.addEventListener('DOMContentLoaded', function() {
                        const ref = document.querySelector('starlight-theme-select')

                        ref.addEventListener('change', function() {
                            const frame = document.querySelector('iframe.giscus-frame')

                            frame.contentWindow.postMessage(
                                {
                                    giscus: {
                                        setConfig: {
                                            theme: getThemeValue()
                                        }
                                    }
                                },
                                '*'
                            )
                        })
                    })
                }
            }

            customElements.define('giscus-comments', GiscusComments);
        </script>
    )
}
